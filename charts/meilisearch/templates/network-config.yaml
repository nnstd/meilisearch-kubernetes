{{- if .Values.sharding.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "meilisearch.fullname" . }}-network-config
  labels:
    {{- include "meilisearch.labels" . | nindent 4 }}
data:
  configure-network.sh: |
    #!/bin/sh
    set -e
    
    # Extract pod ordinal from hostname
    POD_ORDINAL=${HOSTNAME##*-}
    POD_NAME="node-${POD_ORDINAL}"
    
    # Wait for Meilisearch to be ready
    echo "Waiting for Meilisearch to be ready..."
    until curl -sf http://localhost:{{ .Values.service.port }}/health > /dev/null 2>&1; do
      echo "Waiting for Meilisearch..."
      sleep 2
    done
    echo "Meilisearch is ready!"
    
    # Build the remotes JSON object
    REMOTES="{"
    REPLICA_COUNT={{ .Values.sharding.replicaCount }}
    FIRST=true
    
    for i in $(seq 0 $((REPLICA_COUNT - 1))); do
      if [ "$i" != "$POD_ORDINAL" ]; then
        if [ "$FIRST" = false ]; then
          REMOTES="${REMOTES},"
        fi
        FIRST=false
        NODE_NAME="node-${i}"
        NODE_URL="http://{{ include "meilisearch.fullname" . }}-${i}.{{ include "meilisearch.fullname" . }}-headless.${NAMESPACE}.svc.cluster.local:{{ .Values.service.port }}"
        REMOTES="${REMOTES}\"${NODE_NAME}\":{\"url\":\"${NODE_URL}\",\"searchApiKey\":\"${MEILI_MASTER_KEY}\",\"writeApiKey\":\"${MEILI_MASTER_KEY}\"}"
      fi
    done
    REMOTES="${REMOTES}}"
    
    echo "Using ${POD_NAME} as self node"
    echo "Configuring experimental-features"
    echo ""

    # Step 1: Enable network in experimental-features
    curl -sS -X PATCH "http://localhost:{{ .Values.service.port }}/experimental-features" \
      -H "Authorization: Bearer ${MEILI_MASTER_KEY}" \
      -H "Content-Type: application/json" \
      -d '{"network": true}' || echo "Warning: Failed to enable sharding"

    echo "Configuring network topology"
    echo ""
    
    # Step 2: Configure network topology
    curl -sS -X PATCH "http://localhost:{{ .Values.service.port }}/network" \
      -H "Authorization: Bearer ${MEILI_MASTER_KEY}" \
      -H "Content-Type: application/json" \
      -d "{\"sharding\": true,\"self\":\"${POD_NAME}\",\"remotes\":${REMOTES}}" || echo "Warning: Failed to configure network"
    
    echo ""
    echo "Network configuration completed for ${POD_NAME}"
{{- end }}
